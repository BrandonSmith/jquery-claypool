Claypool.Server={};(function(c,a,b){c.router("hijax:server",{event:"claypool:serve",strategy:"first",routerKeys:"urls",hijaxKey:"request",eventNamespace:"Claypool:Server:HijaxServerController",target:function(e,d){return d.url}})})(jQuery,Claypool,Claypool.Server);(function(c,a,b){b.Servlet=function(d){a.extend(this,a.MVC.Controller);c.extend(true,this,d);this.logger=c.logger("Claypool.Server.Servlet")};c.extend(b.Servlet.prototype,a.MVC.Controller.prototype,{handle:function(g,h,f,d){d=c.extend(true,d,g,{write:function(e){d.body=e;return this},append:function(e){d.body+=e;return this}});d.headers.status=200;try{switch(f.method.toUpperCase()){case"GET":this.logger.debug("Handling GET request");this.handleGet(f,d);break;case"POST":this.logger.debug("Handling POST request");this.handlePost(f,d);break;case"PUT":this.logger.debug("Handling PUT request");this.handlePut(f,d);break;case"DELETE":this.logger.debug("Handling DELETE request");this.handleDelete(f,d);break;case"HEAD":this.logger.debug("Handling HEAD request");this.handleHead(f,d);break;case"OPTIONS":this.logger.debug("Handling OPTIONS request");this.handleOptions(f,d);break;default:this.logger.debug("Unknown Method: %s, rendering error response.",f.method);this.handleError(f,d,"Unknown Method: "+f.method)}}catch(i){this.logger.exception(i);this.handleError(f,d,"Caught Exception in Servlet handler",i)}},handleGet:function(e,d){throw new a.MethodNotImplementedError()},handlePost:function(e,d){throw new a.MethodNotImplementedError()},handlePut:function(e,d){throw new a.MethodNotImplementedError()},handleDelete:function(e,d){throw new a.MethodNotImplementedError()},handleHead:function(e,d){throw new a.MethodNotImplementedError()},handleOptions:function(e,d){throw new a.MethodNotImplementedError()},handleError:function(f,d,h,g){this.logger.warn("The default error response should be overriden");d.headers.status=300;d.body=h?h:"Unknown internal error\n";d.body+=g&&g.msg?g.msg:(g?g:"\nUnpsecified Error.")},resolve:function(d){this.logger.warn("The default resolve response is meant to be overriden to allow the rendering of a custom view.");return d.response}})})(jQuery,Claypool,Claypool.Server);(function(d,a,c,f){var b;f.RestServlet=function(g){a.extend(this,f.Servlet);d.extend(true,this,c.Factory(g));b=d.logger("Claypool.Server.RestServlet");this.js2json=jsPath&&jsPath.js2json&&d.isFunction(jsPath.js2json)?jsPath.js2json:g.js2json;this.json2js=jsPath&&jsPath.json2js&&d.isFunction(jsPath.json2js)?jsPath.json2js:g.json2js};d.extend(f.RestServlet.prototype,f.Servlet.prototype,{handleGet:function(j,h){var n=this,k=h.params("domain"),m=h.params("id"),i,g;b.debug("Handling GET for %s %s",k,m);if(!k&&!m){this.db.get({async:false,success:function(o){h.headers.status=200;h.body=n.js2json(d.extend(o,h.params()))},error:function(o){e(o,h,n)}})}else{if(k&&!m){b.debug("Handling GET for %s %s",k,j.params);for(var l in j.parameters){b.debug("param[%s]=%s",l,j.parameters[l])}if(j.parameters&&("id" in j.parameters)){b.debug("LIST OF ITEMS!!!");i=j.parameters.id.split(",");g="select * from `"+k+"` where itemName() in ('"+i.join("','")+"')";b.debug("%s",g);this.db.find({select:g,async:false,success:function(o){h.headers.status=200;h.body=n.js2json(d.extend(o,h.params()))},error:function(o){e(o,h,n)}})}else{b.debug("LIST OF ITEM NAMES!!!",k,m);this.db.find({select:"select itemName() from `"+k+"`",async:false,success:function(o){h.headers.status=200;h.body=n.js2json(d.extend(o,h.params()))},error:function(o){e(o,h,n)}})}}else{if(k&&m&&m!="metadata"){this.db.get({domain:k,id:m,async:false,dataType:"text",success:function(o){h.headers.status=200;h.body=n.js2json(d.extend(o,h.params()))},error:function(o){e(o,h,n)}})}else{if(k&&m&&m=="metadata"){this.db.metadata({domain:k,id:m,async:false,dataType:"text",success:function(o){h.headers.status=200;h.body=n.js2json(d.extend(o,h.params()))},error:function(o){e(o,h,n)}})}}}}},handlePost:function(j,h){var n=this,l=h.params("domain"),m=h.params("id"),i,g,k;b.debug("Handling POST for %s %s",l,m).debug("Reading POST body %s",j.body);if(l&&m){b.debug("saving single object",j.body);i=this.json2js(j.body);this.db.save({domain:l,id:m,data:i,async:false,replace:("update" in j.parameters)?false:true,success:function(p){var o=n.js2json(d.extend(p,h.params()));b.debug("response %s",o);h.headers.status=200;h.body=o},error:function(o){e(o,h,n)}})}else{if(l&&!m){b.debug("saving array of objects (bulk save)");g=this.json2js(j.body);this.db.save({domain:l,data:g,async:false,batch:true,replace:("update" in j.parameters)?false:true,success:function(o){h.headers.status=200;h.body=n.js2json(d.extend(o,h.params()));b.debug("resultset %s",h.body)},error:function(o){e(o,h,n)}})}else{if(!l&&!m){k=j.body;if(j.contentType.match("application/json")){k=js2query(this.json2js(k))}b.debug("executing query \n%s",k);this.db.find({select:k,async:false,success:function(o){h.headers.status=200;h.body=n.js2json(d.extend(o,h.params()));b.debug("resultset %s",h.body)},error:function(o){e(o,h,n)}})}}}},handlePut:function(h,g){var j=this,i=g.params("domain");b.debug("Handling PUT for %s %s",i);if(i){this.db.create({domain:i,async:false,success:function(k){g.headers.status=200;g.body=j.js2json(d.extend(k,g.params()))},error:function(k){e(k,g,j)}})}},handleDelete:function(h,g){var k=this,i=g.params("domain"),j=g.params("id");b.debug("Handling DELETE for %s %s",i,j);if(i&&j){this.db.remove({domain:i,id:j,async:false,success:function(l){g.headers.status=200;g.body=k.js2json(d.extend(l,g.params()))},error:function(l){e(l,g,k)}})}else{if(i&&!j){this.db.destroy({domain:i,async:false,success:function(l){g.headers.status=200;g.body=k.js2json(d.extend(l,g.params()))},error:function(l){e(l,g,k)}})}}}});var e=function(h,i,j){var g=j.js2json(h);b.error("failed. %s",g);i.headers.status=h.$code?h.$code:500;i.body=g?g:"{'db$error':{'$code'  : 500,'$type'  : 'UnknownClaypoolWrapperError','$msg'   : 'unknown error, check network'}}"}})(jQuery,Claypool,Claypool.Models,Claypool.Server);(function(d,a,c){var b;c.WebProxyServlet=function(f){a.extend(this,c.Servlet);this.rewriteMap=null;d.extend(true,this,f);b=d.logger("Claypool.Server.WebProxyServlet");this.router=new a.Router();this.strategy=this.strategy||"first";b.debug("Compiling url rewrites %s.",this.rewriteMap);this.router.compile(this.rewriteMap,"urls")};d.extend(c.WebProxyServlet.prototype,c.Servlet.prototype,{handleGet:function(i,g){var h=e.route(i,this);var f=h.proxyURL,j=h.params;if(f&&f.length&&f.length>0){b.debug("Proxying get request to: %s",f[0].payload.rewrite);d.ajax({type:"GET",dataType:"text",async:false,data:j,url:f[0].payload.rewrite+"",beforeSend:function(k){e.beforeSend(i,g,k)},success:function(k){e.success(g,k)},error:function(m,k,l){e.error(g,m,k,l)},complete:function(l,k){e.complete(g,f,l,k)}})}return g},handlePost:function(i,g){var h=e.route(i,this);var f=h.proxyURL,j=h.params;if(f&&f.length&&f.length>0){b.debug("Proxying post request to: %s",f[0].payload.rewrite);d.ajax({type:"POST",dataType:"text",async:false,data:j,url:f[0].payload.rewrite+"",beforeSend:function(k){e.beforeSend(i,g,k)},success:function(k){e.success(g,k)},error:function(m,k,l){e.error(g,m,k,l)},complete:function(l,k){e.complete(g,f,l,k)}})}return g}});var e={route:function(i,h){b.debug("Handling proxy: %s",i.requestURI);var g=h.router[h.strategy||"all"](i.requestURI);i.headers["Claypool-Proxy"]=h.proxyHost||"127.0.0.1";var j={};for(var k in i.parameters){b.debug("request.parameters[%s]=%s",k,i.parameters[k]);j[k+""]=i.parameters[k]+""}var f=(i.body&&i.body.length)?i.body:"";return{proxyURL:g,params:j,body:f}},beforeSend:function(g,f,h){b.debug("Copying Request headers for Proxied Request");for(var i in g.headers){b.debug("Setting proxied request header %s: %s",i,g.headers[i]);h.setRequestHeader(i,g.headers[i])}f.headers={}},success:function(f,g){b.debug("Got response for proxy \n %s.",g);f.body=g+""},error:function(g,i,f,h){b.error("Error proxying request. STATUS: %s",f?f:"UNKNOWN");if(h){b.exception(h)
}g.body=i.responseText+""},complete:function(h,l,o,j){b.debug("Proxy Request Complete, Copying response headers");var f=o.getAllResponseHeaders();var g;var m;b.debug("Complete Proxy response header: \n %s",f);f=f.split("\r\n");for(var k=0;k<f.length;k++){m=f[k].split(":");try{b.debug("setting response header %s %s",m[0],m.join(":"));h.headers[m.shift()]=m.join(":")}catch(n){b.warn("Unable to set a proxied response header");b.exception(n)}}b.debug("response status (%s)",o.status);h.headers.status=Number(o.status);h.headers["Claypool-Proxy"]=l[0].payload.rewrite+"";h.headers["Content-Encoding"]=l[0].payload.contentEncoding||"";h.headers["Transfer-Encoding"]=l[0].payload.transferEncoding||"";if(l[0].payload.contentType){h.headers["Content-Type"]=l[0].payload.contentType+""}}}})(jQuery,Claypool,Claypool.Server);(function($,$$,$$Web){$$Web.ConsoleServlet=function(options){$$.extend(this,$$Web.Servlet);$.extend(true,this,options);this.logger=$.logger("Claypool.Server.ConsoleServlet")};$.extend($$Web.ConsoleServlet.prototype,$$Web.Servlet.prototype,{handlePost:function(request,response){var retval="ok";try{this.logger.info("Executing command :\n%s",request.body);retval=eval(String(request.body));retval=(retval===undefined)?"ok":retval;this.logger.info("Finished Executing command :\n%s",request.body);response.body=retval||"error: see server logs."}catch(e){this.logger.error("Error executing command. \n\n%s",request.body).exception(e);response.body=e.toString()}response.body=retval;response.headers["Content-Type"]="text/plain";response.headers.status=200;return response}})})(jQuery,Claypool,Claypool.Server);(function(c,a,b){b.Console=function(d){c.extend(true,this,d);this.logger=c.logger("Claypool.Server.Console")};c.extend(b.Console.prototype,{run:function(d){var e=this;c.ajax({type:"POST",url:"console/",processData:false,contentType:"text",data:d,success:function(f){e.logger.info(f)},error:function(h,f,g){e.logger.error("Error sending command (%s)",s).exception(g)}})}})})(jQuery,Claypool,Claypool.Server);(function(c,a,b){})(jQuery,Claypool,Claypool.Server);(function(e,b,c){var d;var a;e.extend(e,{">":function(f){a=a||new c.Console();a.run(f)},serve:function(g,f){d=d||e.logger("Claypool.Server");d.info("Handling global request routing for request: %s ",g.requestURL).debug("Dispatching request to Server Sevlet Container");f.headers={};e.extend(f.headers,{contentType:"text/html",status:404});f.body="<html><head></head><body>Not Found :\n\t"+g.requestURL+"</body></html>";try{e(document).trigger("claypool:serve",[{url:g.requestURL},g,f])}catch(h){d.error("Error Handling Request.").exception(h);f.headers["Content-Type"]="text/html";f.headers.status=500;f.body="<html><head></head><body>"+h||"Unknown Error</body></html>"}},servlet:function(f){b.extend(f,c.Servlet)},proxy:function(f){return e.invert([{id:f.id||"proxy_"+e.guid(),clazz:"Claypool.Server.WebProxyServlet",options:[{rewriteMap:f.rewrite}]}])}});ClaypoolServerHandler=e.serve})(jQuery,Claypool,Claypool.Server);